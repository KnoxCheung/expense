<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Family Expense Manager</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Roboto", sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f4f7f6;
                color: #333;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }
            .header {
                text-align: center;
                margin-bottom: 30px;
            }
            .header h1 {
                color: #2c3e50;
            }
            .content {
                display: flex;
                gap: 30px;
            }
            .panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px;
                flex: 1;
            }
            h2 {
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 10px;
            }
            input,
            select,
            button {
                width: 100%;
                padding: 10px;
                margin-bottom: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                background-color: #3498db;
                color: white;
                border: none;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #2980b9;
            }
            .expense-item {
                background-color: #ecf0f1;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 4px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .expense-item button {
                background-color: #e74c3c;
                padding: 5px 10px;
                width: auto;
            }
            .expense-item button:hover {
                background-color: #c0392b;
            }
            #pieChartContainer {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
            }
            .calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 5px;
                margin-top: 20px;
            }
            .calendar-day {
                border: 1px solid #ddd;
                padding: 5px;
                text-align: center;
                background-color: #fff;
            }
            .calendar-day.has-expenses {
                background-color: #3498db;
                color: white;
                cursor: pointer;
            }
            #alarms {
                margin-top: 20px;
                color: #e74c3c;
            }
            .budget-status-item {
                padding: 10px;
                margin-bottom: 5px;
                border-radius: 4px;
            }
            .budget-status-good {
                background-color: #2ecc71;
                color: white;
            }
            .budget-status-normal {
                background-color: #f39c12;
                color: white;
            }
            .budget-status-over {
                background-color: #e74c3c;
                color: white;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Family Expense Manager</h1>
            </div>
            <div class="content">
                <div class="panel">
                    <h2>Add Expense</h2>
                    <select id="category">
                        <option value="">Select Category</option>
                        <option value="indoorCooking">Indoor Cooking</option>
                        <option value="outdoorDinners">Outdoor Dinners</option>
                        <option value="transportFees">Transport Fees</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="education">Education</option>
                        <option value="shopping">Shopping</option>
                        <option value="medicalFees">Medical Fees</option>
                    </select>
                    <input type="text" id="date" placeholder="Date" />
                    <input type="number" id="amount" placeholder="Amount" />
                    <button onclick="addExpense()">Add Expense</button>

                    <h2>Add Recurring Expense</h2>
                    <select id="recurringCategory">
                        <option value="">Select Category</option>
                        <option value="indoorCooking">Indoor Cooking</option>
                        <option value="outdoorDinners">Outdoor Dinners</option>
                        <option value="transportFees">Transport Fees</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="education">Education</option>
                        <option value="shopping">Shopping</option>
                        <option value="medicalFees">Medical Fees</option>
                    </select>
                    <input
                        type="number"
                        id="recurringAmount"
                        placeholder="Amount"
                    />
                    <input
                        type="text"
                        id="recurringDate"
                        placeholder="Start Date"
                    />
                    <select id="recurringFrequency">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                    <button onclick="addRecurringExpense()">
                        Add Recurring Expense
                    </button>

                    <h2>Update Budget Limit</h2>
                    <select id="budgetCategory">
                        <option value="">Select Category</option>
                        <option value="indoorCooking">Indoor Cooking</option>
                        <option value="outdoorDinners">Outdoor Dinners</option>
                        <option value="transportFees">Transport Fees</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="education">Education</option>
                        <option value="shopping">Shopping</option>
                        <option value="medicalFees">Medical Fees</option>
                    </select>
                    <input
                        type="number"
                        id="goodLimit"
                        placeholder="Good Limit"
                    />
                    <input
                        type="number"
                        id="normalLimit"
                        placeholder="Normal Limit"
                    />
                    <button onclick="updateBudgetLimit()">
                        Update Budget Limit
                    </button>

                    <h2>Expense List</h2>
                    <div id="expenseList"></div>

                    <h2>Recurring Expense List</h2>
                    <div id="recurringExpenseList"></div>

                    <h2>Expenses in Range</h2>
                    <input
                        type="text"
                        id="startDate"
                        placeholder="Start Date"
                    />
                    <input type="text" id="endDate" placeholder="End Date" />
                    <button onclick="fetchExpensesForRange()">
                        Fetch Expenses
                    </button>
                    <div id="expensesInRange"></div>

                    <button
                        onclick="clearAllData()"
                        style="background-color: #e74c3c; margin-top: 20px"
                    >
                        Clear All Data
                    </button>
                </div>
                <div class="panel">
                    <h2>Expense Summary</h2>
                    <div id="pieChartContainer">
                        <canvas id="pieChart"></canvas>
                    </div>

                    <h2>Budget Status</h2>
                    <div id="budgetStatus"></div>

                    <h2>Weekly Reminder</h2>
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="Enter your email"
                    />
                    <button onclick="sendWeeklyReminder()">
                        Send Reminder
                    </button>

                    <h2>Weekly Expense Alarms</h2>
                    <div id="alarms"></div>

                    <h2>Monthly Calendar</h2>
                    <input type="month" id="monthPicker" />
                    <div id="calendar" class="calendar"></div>
                </div>
            </div>
        </div>

        <script>
            let expenses = [];
            let recurringExpenses = [];
            let pieChart;

            function addExpense() {
                const category = document.getElementById("category").value;
                const amount = parseFloat(
                    document.getElementById("amount").value,
                );
                const date = document.getElementById("date").value;

                if (category && amount && date) {
                    fetch("/api/add_expense", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ category, amount, date }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "success") {
                                fetchExpenses();
                                fetchBudgetStatus();
                                fetchWeeklyExpenseAlarms();
                                updateMonthlyCalendar();
                            }
                        })
                        .catch((error) => console.error("Error:", error));
                }
            }

            function addRecurringExpense() {
                const category =
                    document.getElementById("recurringCategory").value;
                const amount = parseFloat(
                    document.getElementById("recurringAmount").value,
                );
                const frequency =
                    document.getElementById("recurringFrequency").value;
                const date = document.getElementById("recurringDate").value;

                if (category && amount && frequency && date) {
                    fetch("/api/add_recurring_expense", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            category,
                            amount,
                            frequency,
                            date,
                        }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "success") {
                                fetchRecurringExpenses();
                            }
                        })
                        .catch((error) => console.error("Error:", error));
                }
            }

            function updateBudgetLimit() {
                const category =
                    document.getElementById("budgetCategory").value;
                const goodLimit = parseFloat(
                    document.getElementById("goodLimit").value,
                );
                const normalLimit = parseFloat(
                    document.getElementById("normalLimit").value,
                );

                if (category && goodLimit && normalLimit) {
                    fetch("/api/update_budget_limit", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            category,
                            goodLimit,
                            normalLimit,
                        }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "success") {
                                fetchBudgetStatus();
                                fetchWeeklyExpenseAlarms();
                            }
                        })
                        .catch((error) => console.error("Error:", error));
                }
            }

            function updateExpenseList() {
                const list = document.getElementById("expenseList");
                list.innerHTML = "";
                expenses.forEach((expense, index) => {
                    list.innerHTML += `
                <div class="expense-item">
                    <span>${expense.category}: $${expense.amount} on ${expense.date}</span>
                    <button onclick="removeExpense(${index})">Remove</button>
                </div>`;
                });
            }

            function updateRecurringExpenseList() {
                const list = document.getElementById("recurringExpenseList");
                list.innerHTML = "";
                recurringExpenses.forEach((expense, index) => {
                    list.innerHTML += `
                <div class="expense-item">
                    <span>${expense.category}: $${expense.amount} (${expense.frequency}) starting ${expense.date}</span>
                    <button onclick="removeRecurringExpense(${index})">Remove</button>
                </div>`;
                });
            }

            function removeExpense(index) {
                expenses.splice(index, 1);
                updateExpenseList();
                updatePieChart();
                fetchBudgetStatus();
            }

            function removeRecurringExpense(index) {
                recurringExpenses.splice(index, 1);
                updateRecurringExpenseList();
            }

            function updatePieChart() {
                const ctx = document
                    .getElementById("pieChart")
                    .getContext("2d");
                const data = {};
                expenses.forEach((expense) => {
                    if (data[expense.category]) {
                        data[expense.category] += expense.amount;
                    } else {
                        data[expense.category] = expense.amount;
                    }
                });

                if (pieChart) {
                    pieChart.destroy();
                }

                pieChart = new Chart(ctx, {
                    type: "pie",
                    data: {
                        labels: Object.keys(data),
                        datasets: [
                            {
                                data: Object.values(data),
                                backgroundColor: [
                                    "#FF6384",
                                    "#36A2EB",
                                    "#FFCE56",
                                    "#4BC0C0",
                                    "#9966FF",
                                    "#FF9F40",
                                    "#FF6384",
                                ],
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                    },
                });
            }

            function fetchExpenses() {
                fetch("/api/get_expenses")
                    .then((response) => response.json())
                    .then((data) => {
                        expenses = data.expenses;
                        updateExpenseList();
                        updatePieChart();
                    });
            }

            function fetchRecurringExpenses() {
                fetch("/api/get_recurring_expenses")
                    .then((response) => response.json())
                    .then((data) => {
                        recurringExpenses = data.recurring_expenses;
                        updateRecurringExpenseList();
                    });
            }

            function fetchBudgetStatus() {
                fetch("/api/get_budget_status")
                    .then((response) => response.json())
                    .then((data) => {
                        const status = document.getElementById("budgetStatus");
                        status.innerHTML = "";
                        for (const [category, limits] of Object.entries(data)) {
                            const totalSpent = expenses
                                .filter((e) => e.category === category)
                                .reduce((sum, e) => sum + e.amount, 0);
                            let statusClass = "budget-status-good";
                            if (totalSpent > limits.normal) {
                                statusClass = "budget-status-over";
                            } else if (totalSpent > limits.good) {
                                statusClass = "budget-status-normal";
                            }
                            status.innerHTML += `
                            <div class="budget-status-item ${statusClass}">
                                <strong>${category}</strong><br>
                                Spent: $${totalSpent.toFixed(2)}<br>
                                Good Limit: $${limits.good}<br>
                                Normal Limit: $${limits.normal}
                            </div>
                        `;
                        }
                    });
            }

            function fetchExpensesForRange() {
                const startDate = document.getElementById("startDate").value;
                const endDate = document.getElementById("endDate").value;
                fetch(
                    `/api/get_expenses_for_range?start_date=${startDate}&end_date=${endDate}`,
                )
                    .then((response) => response.json())
                    .then((data) => {
                        const rangeList =
                            document.getElementById("expensesInRange");
                        rangeList.innerHTML = "<h3>Expenses in Range:</h3>";
                        data.expenses.forEach((expense) => {
                            rangeList.innerHTML += `<p>${expense.date}: ${expense.category} - $${expense.amount}</p>`;
                        });
                    })
                    .catch((error) => console.error("Error:", error));
            }

            function clearAllData() {
                if (
                    confirm(
                        "Are you sure you want to clear all expense data? This action cannot be undone.",
                    )
                ) {
                    fetch("/api/clear_data", { method: "POST" })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "success") {
                                fetchExpenses();
                                fetchRecurringExpenses();
                                fetchBudgetStatus();
                                fetchWeeklyExpenseAlarms();
                                updateMonthlyCalendar();
                            }
                        })
                        .catch((error) => console.error("Error:", error));
                }
            }

            function sendWeeklyReminder() {
                const email = document.getElementById("emailInput").value;
                if (email) {
                    fetch("/api/send_reminder", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email }),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "success") {
                                alert("Reminder sent successfully!");
                            } else {
                                alert(
                                    "Failed to send reminder. Please try again.",
                                );
                            }
                        })
                        .catch((error) => console.error("Error:", error));
                } else {
                    alert("Please enter an email address.");
                }
            }

            function fetchWeeklyExpenseAlarms() {
                fetch("/api/get_weekly_expense_alarm")
                    .then((response) => response.json())
                    .then((data) => {
                        const alarmsDiv = document.getElementById("alarms");
                        alarmsDiv.innerHTML = "";
                        data.alarms.forEach((alarm) => {
                            const p = document.createElement("p");
                            p.textContent = alarm;
                            alarmsDiv.appendChild(p);
                        });
                    })
                    .catch((error) => console.error("Error:", error));
            }

            function updateMonthlyCalendar() {
                const monthPicker = document.getElementById("monthPicker");
                const [year, month] = monthPicker.value.split("-");

                fetch(`/api/get_monthly_calendar?year=${year}&month=${month}`)
                    .then((response) => response.json())
                    .then((data) => {
                        const calendarDiv = document.getElementById("calendar");
                        calendarDiv.innerHTML = "";

                        data.calendar.forEach((week) => {
                            week.forEach((day) => {
                                const dayDiv = document.createElement("div");
                                dayDiv.className = "calendar-day";
                                if (day !== 0) {
                                    dayDiv.textContent = day;
                                    if (data.expenses[day]) {
                                        dayDiv.classList.add("has-expenses");
                                        const total = data.expenses[day].reduce(
                                            (sum, exp) => sum + exp.amount,
                                            0,
                                        );
                                        dayDiv.title = `Total: $${total.toFixed(2)}`;
                                        dayDiv.onclick = () =>
                                            showDayExpenses(data.expenses[day]);
                                    }
                                }
                                calendarDiv.appendChild(dayDiv);
                            });
                        });
                    })
                    .catch((error) => console.error("Error:", error));
            }

            function showDayExpenses(expenses) {
                alert(JSON.stringify(expenses, null, 2));
            }

            // Initialize Flatpickr for date inputs
            flatpickr("#date", { dateFormat: "Y-m-d", defaultDate: "today" });
            flatpickr("#recurringDate", {
                dateFormat: "Y-m-d",
                defaultDate: "today",
            });
            flatpickr("#startDate", {
                dateFormat: "Y-m-d",
                defaultDate: "today",
            });
            flatpickr("#endDate", {
                dateFormat: "Y-m-d",
                defaultDate: "today",
            });
            flatpickr("#monthPicker", {
                plugins: [
                    new monthSelectPlugin({
                        shorthand: true,
                        dateFormat: "Y-m",
                        altFormat: "F Y",
                        theme: "light",
                    }),
                ],
                defaultDate: "today",
                onChange: updateMonthlyCalendar,
            });

            // Initial render
            document.addEventListener("DOMContentLoaded", function () {
                fetchExpenses();
                fetchRecurringExpenses();
                fetchBudgetStatus();
                fetchWeeklyExpenseAlarms();
                updateMonthlyCalendar();
            });
        </script>
    </body>
</html>
